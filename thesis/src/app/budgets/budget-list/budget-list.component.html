<div class="flex flex-col justify-between gap-4 sm:flex-row">
  <input
    hlmInput
    class="w-full md:w-80"
    placeholder="Filter budgets..."
    [ngModel]="_budgetsFilter()"
    (ngModelChange)="_rawFilterInput.set($event)"
  />
  <button
    hlmBtn
    brnDialogTrigger
    [brnDialogTriggerFor]="newDialog"
    class="justify-center rounded-sm text-white hover:text-gray-400"
  >
    New
  </button>
</div>

<brn-table
  hlm
  stickyHeader
  class="w-full border-border mt-10 block h-8/12 overflow-auto"
  [dataSource]="_filteredSortedPaginatedBudgets()"
  [displayedColumns]="_allDisplayedColumns()"
  [trackBy]="_trackBy"
>
  <brn-column-def name="category" class="w-3/12 md:w-2/12 justify-center">
    <hlm-th truncate *brnHeaderDef class="text-center">Category</hlm-th>
    <hlm-td
      truncate
      *brnCellDef="let element"
      class="justify-center text-center"
    >
      <div class="w-full h-full flex justify-center text-center align-middle">
        <hlm-icon class="ml-2" size="lg" [name]="element.category.icon" />
      </div>
    </hlm-td>
  </brn-column-def>

  <brn-column-def
    name="resetDate"
    class="max-md:hidden w-2/12 justify-start text-start"
  >
    <hlm-th *brnHeaderDef truncate>
      <button
        hlmBtn
        class="p-0"
        size="sm"
        variant="ghost"
        (click)="handleDateSortChange()"
      >
        Reset Date
        <hlm-icon class="ml-2" size="sm" name="lucideArrowUpDown" />
      </button>
    </hlm-th>
    <hlm-td *brnCellDef="let element">
      {{ element.resetDate | date }}
    </hlm-td>
  </brn-column-def>

  <brn-column-def
    name="progress"
    class="w-5/12 sm:w-4/12 justify-start text-start"
  >
    <hlm-th *brnHeaderDef>Progress</hlm-th>
    <hlm-td
      class="text-start justify-start font-medium tabular-nums h-full px-4"
      *brnCellDef="let element"
    >
      <div
        class="relative flex text-start justify-start w-full h-full overflow-visible group"
      >
        <brn-progress
          hlmProgressIndicator
          aria-labelledby="loading"
          class="w-full bg-base-200 h-6 flex justify-start text-start"
          [value]="100"
        >
          <div
            class="bg-primary h-6 rounded-full text-white text-xs flex items-start justify-start"
            [ngStyle]="{
              width: (element.amountSpent / element.amountAvailable) * 100 + '%'
            }"
          ></div>
        </brn-progress>
        <div
          class="absolute h-full justify-start inset-0 bg-gray-100 text-center text-gray-700 rounded-badge p-0 opacity-0 group-hover:opacity-100 transition-opacity w-full sm:w-auto sm:max-w-sm text-xs whitespace-normal"
        >
          Spent: {{ element.amountSpent | number : "1.2-2" }}
          {{ element.currency }}, Remaining:
          {{ element.amountAvailable - element.amountSpent | number : "1.2-2" }}
          {{ element.currency }}
        </div>
      </div>
    </hlm-td>
  </brn-column-def>

  <brn-column-def
    name="amountAvailable"
    class="w-3/12 md:w-2/12 justify-start text-start"
  >
    <hlm-th *brnHeaderDef>Available Amount</hlm-th>
    <hlm-td
      class="text-start font-medium tabular-nums"
      *brnCellDef="let element"
    >
      {{ element.amountAvailable | number : "1.2-2" }} {{ element.currency }}
    </hlm-td>
  </brn-column-def>

  <brn-column-def name="isShared" class="max-sm:hidden w-1/12 justify-center">
    <hlm-th *brnHeaderDef>Shared</hlm-th>
    <hlm-td
      class="text-start font-medium tabular-nums"
      *brnCellDef="let element"
    >
      {{ element.category.isShared ? "Yes" : "No" }}
    </hlm-td>
  </brn-column-def>

  <brn-column-def name="actions" class="w-1/12 justify-center">
    <hlm-th *brnHeaderDef></hlm-th>
    <hlm-td *brnCellDef="let element">
      <button
        hlmBtn
        variant="ghost"
        class="h-6 w-6 p-0.5"
        align="end"
        [brnMenuTriggerFor]="menu"
      >
        <hlm-icon class="h-4 w-4" name="lucideMoreHorizontal" />
      </button>

      <ng-template #menu>
        <hlm-menu>
          <hlm-menu-label>Actions</hlm-menu-label>
          <hlm-menu-separator />
          <hlm-menu-group>
            <button
              brnDialogTrigger
              [brnDialogTriggerFor]="editDialog"
              (click)="selectBudget(element)"
            >
              Edit
            </button>
          </hlm-menu-group>
          <hlm-menu-separator />
          <hlm-menu-group>
            <hlm-menu-group>
              <button
                brnDialogTrigger
                [brnDialogTriggerFor]="deleteDialog"
                (click)="selectBudget(element)"
              >
                Delete
              </button>
            </hlm-menu-group>
          </hlm-menu-group>
        </hlm-menu>
      </ng-template>
    </hlm-td>
  </brn-column-def>

  <div
    class="text-muted-foreground flex items-center justify-center p-20"
    brnNoDataRow
  >
    No data
  </div>
</brn-table>

<hlm-dialog #newDialog>
  <hlm-dialog-content class="sm:max-w-[425px]" *brnDialogContent="let ctx">
    <hlm-dialog-header>
      <h3 hlmDialogTitle>New Budget</h3>
      <p hlmDialogDescription>Add the details for the new budget.</p>
    </hlm-dialog-header>

    <div class="py-4 grid gap-4">
      <div class="items-center grid grid-cols-4 gap-4">
        <label hlmLabel for="category" class="text-right">Category</label>
        <brn-select
          id="currency"
          [(ngModel)]="newBudget.category"
          class="col-span-3"
        >
          <hlm-select-trigger class="w-full">
            <hlm-select-value />
          </hlm-select-trigger>
          <hlm-select-content>
            <hlm-option
              *ngFor="let category of availableCategories"
              [value]="category"
            >
              {{ category.name }}
            </hlm-option>
          </hlm-select-content>
        </brn-select>
      </div>

      <div class="items-center grid grid-cols-4 gap-4">
        <label hlmLabel for="postingDate" class="text-right">Start Date</label>
        <input
          type="date"
          hlmInput
          id="postingDate"
          [(ngModel)]="newBudget.startDate"
          class="col-span-3"
        />
      </div>

      <div class="items-center grid grid-cols-4 gap-4">
        <label hlmLabel for="amount" class="text-right">Available Amount</label>
        <input
          type="number"
          hlmInput
          id="amount"
          [(ngModel)]="newBudget.amountAvailable"
          class="col-span-3"
        />
      </div>

      <div class="items-center grid grid-cols-4 gap-4">
        <label hlmLabel for="currency" class="text-right">Currency</label>
        <brn-select
          id="currency"
          [(ngModel)]="newBudget.currency"
          class="col-span-3"
        >
          <hlm-select-trigger class="w-full">
            <hlm-select-value />
          </hlm-select-trigger>
          <hlm-select-content>
            <hlm-option *ngFor="let currency of currencies" [value]="currency">
              {{ currency }}
            </hlm-option>
          </hlm-select-content>
        </brn-select>
      </div>
    </div>

    <hlm-dialog-footer>
      <button hlmBtn variant="ghost" (click)="ctx.close()">Cancel</button>
      <button
        hlmBtn
        class="text-white hover:text-gray-400"
        (click)="addBudget(); ctx.close()"
      >
        Save
      </button>
    </hlm-dialog-footer>
  </hlm-dialog-content>
</hlm-dialog>

<hlm-dialog #editDialog>
  <hlm-dialog-content class="sm:max-w-[425px]" *brnDialogContent="let ctx">
    <hlm-dialog-header>
      <h3 hlmDialogTitle>Edit Budget</h3>
      <p hlmDialogDescription>
        Modify the Budget details and click save to apply changes.
      </p>
    </hlm-dialog-header>

    <div class="items-center grid grid-cols-4 gap-4">
      <label hlmLabel for="startDate" class="text-right">Start Date</label>
      <input
        type="date"
        hlmInput
        id="startDate"
        [(ngModel)]="selectedBudget.startDate"
        class="col-span-3"
      />
    </div>

    <div class="items-center grid grid-cols-4 gap-4">
      <label hlmLabel for="amount" class="text-right">Amount</label>
      <input
        type="number"
        hlmInput
        id="amount"
        [(ngModel)]="selectedBudget.amountAvailable"
        class="col-span-3"
      />
    </div>

    <div class="items-center grid grid-cols-4 gap-4">
      <label hlmLabel for="currency" class="text-right">Currency</label>
      <brn-select
        id="currency"
        [(ngModel)]="selectedBudget.currency"
        class="col-span-3"
      >
        <hlm-select-trigger class="w-full">
          <hlm-select-value />
        </hlm-select-trigger>
        <hlm-select-content>
          <hlm-option *ngFor="let currency of currencies" [value]="currency">
            {{ currency }}
          </hlm-option>
        </hlm-select-content>
      </brn-select>
    </div>

    <hlm-dialog-footer>
      <button hlmBtn variant="ghost" (click)="ctx.close()">Cancel</button>
      <button
        hlmBtn
        class="text-white hover:text-gray-400"
        (click)="saveBudget(); ctx.close()"
      >
        Save changes
      </button>
    </hlm-dialog-footer>
  </hlm-dialog-content>
</hlm-dialog>

<hlm-dialog #deleteDialog>
  <hlm-dialog-content *brnAlertDialogContent="let ctx">
    <hlm-dialog-header>
      <h3 hlmAlertDialogTitle>Are you absolutely sure?</h3>
      <p hlmAlertDialogDescription>
        This action cannot be undone. This will permanently delete your budget.
      </p>
    </hlm-dialog-header>
    <hlm-dialog-footer>
      <button hlmBtn variant="ghost" (click)="ctx.close()">Cancel</button>
      <button
        hlmBtn
        variant="destructive"
        (click)="deleteBudget(); ctx.close()"
      >
        Delete budget
      </button>
    </hlm-dialog-footer>
  </hlm-dialog-content>
</hlm-dialog>
